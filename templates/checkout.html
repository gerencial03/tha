{% extends "base.html" %}

{% block title %}Finalizar Compra - Tha Beauty{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="checkout-header bg-white border-bottom">
        <div class="container">
            <div class="row align-items-center py-3">
                <div class="col-12 text-center">
                    <h2 class="mb-0 text-dark">Finalizar Compra</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <div class="row">
            <!-- Form Section -->
            <div class="col-lg-8">


                <!-- Customer Info -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">üìã Dados para Entrega</h5>
                    </div>
                    <div class="card-body">
                        <form id="checkout-form">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nome Completo *</label>
                                    <input type="text" id="customer_name" name="customer_name" class="form-control" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">CPF *</label>
                                    <input type="text" id="customer_cpf" name="customer_cpf" class="form-control" required maxlength="14" placeholder="000.000.000-00">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">E-mail *</label>
                                    <input type="email" id="customer_email" name="customer_email" class="form-control" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Telefone *</label>
                                    <input type="tel" id="customer_phone" name="customer_phone" class="form-control" required placeholder="(11) 99999-9999">
                                </div>
                                <div class="col-md-8 mb-3">
                                    <label class="form-label">CEP *</label>
                                    <input type="text" id="customer_cep" name="customer_cep" class="form-control" placeholder="00000-000" maxlength="9" required>
                                    <div class="loading-cep" id="cep-loading" style="display: none;">
                                        <small class="text-primary">üîç Buscando CEP...</small>
                                    </div>
                                    <div class="invalid-cep" id="cep-error" style="display: none;">
                                        <small class="text-danger">‚ùå CEP n√£o encontrado</small>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">N√∫mero *</label>
                                    <input type="text" id="customer_numero" name="customer_numero" class="form-control" required>
                                </div>
                                <div class="col-12 mb-3">
                                    <label class="form-label">Endere√ßo *</label>
                                    <input type="text" id="customer_endereco" name="customer_endereco" class="form-control" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Bairro *</label>
                                    <input type="text" id="customer_bairro" name="customer_bairro" class="form-control" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Cidade *</label>
                                    <input type="text" id="customer_cidade" name="customer_cidade" class="form-control" required>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">UF *</label>
                                    <select id="customer_uf" name="customer_uf" class="form-control">
                                        <option value="">Selecione</option>
                                        <option value="AC">AC</option>
                                        <option value="AL">AL</option>
                                        <option value="AP">AP</option>
                                        <option value="AM">AM</option>
                                        <option value="BA">BA</option>
                                        <option value="CE">CE</option>
                                        <option value="DF">DF</option>
                                        <option value="ES">ES</option>
                                        <option value="GO">GO</option>
                                        <option value="MA">MA</option>
                                        <option value="MT">MT</option>
                                        <option value="MS">MS</option>
                                        <option value="MG">MG</option>
                                        <option value="PA">PA</option>
                                        <option value="PB">PB</option>
                                        <option value="PR">PR</option>
                                        <option value="PE">PE</option>
                                        <option value="PI">PI</option>
                                        <option value="RJ">RJ</option>
                                        <option value="RN">RN</option>
                                        <option value="RS">RS</option>
                                        <option value="RO">RO</option>
                                        <option value="RR">RR</option>
                                        <option value="SC">SC</option>
                                        <option value="SP">SP</option>
                                        <option value="SE">SE</option>
                                        <option value="TO">TO</option>
                                    </select>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Shipping Options -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">üöö Frete Gr√°tis</h5>
                    </div>
                    <div class="card-body">
                        <div class="shipping-options">
                            <!-- Always free shipping -->
                            <div class="alert alert-success text-center mb-0 p-4" style="border: 2px solid #28a745; background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);">
                                <div class="mb-3">
                                    <i class="fas fa-shipping-fast fa-3x text-success"></i>
                                </div>
                                <h4 class="mb-2 text-success fw-bold">üéâ Seu frete √© GR√ÅTIS!</h4>
                                <p class="mb-2 text-dark">Frete gr√°tis para todo o Brasil em todos os pedidos</p>
                                <div class="badge bg-success fs-6 py-2 px-3">Entrega em 2 a 5 dias √∫teis</div>
                                <input type="hidden" name="shipping" value="0">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Summary -->
            <div class="col-lg-4">
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header bg-warning text-white" style="background-color: #e67e22 !important;">
                        <h5 class="mb-0">üí≥ Resumo do Pagamento</h5>
                    </div>
                    <div class="card-body">
                        <div class="payment-summary">
                            <!-- Products Info Section -->
                            <div class="mb-3" id="payment-products-summary">
                                {% if checkout_items %}
                                    <!-- Show all products in checkout -->
                                    {% for item in checkout_items %}
                                    <div class="mb-2 p-2 product-summary-item" style="background-color: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6; position: relative;" data-product-id="{{ item.product.id }}">
                                        <button class="btn-remove-product" onclick="removeProductFromSummary('{{ item.product.id }}')" style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center;">√ó</button>
                                        <div class="d-flex align-items-center">
                                            <img src="{{ item.product.image_url }}" alt="{{ item.product.name }}" 
                                                 class="rounded me-2" style="width: 35px; height: 35px; object-fit: cover;">
                                            <div style="flex: 1;">
                                                <div style="font-size: 11px; font-weight: 600; color: #333; margin-bottom: 2px;">
                                                    {{ item.product.name }}
                                                </div>
                                                <div style="font-size: 9px; color: #666;">
                                                    Quantidade: {{ item.quantity }} √ó R$ {{ "%.2f"|format(item.product.price) }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <!-- Fallback for single product -->
                                    <div class="mb-2 p-2 product-summary-item" style="background-color: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6; position: relative;" data-product-id="{{ product.id }}">
                                        <button class="btn-remove-product" onclick="removeProductFromSummary('{{ product.id }}')" style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center;">√ó</button>
                                        <div class="d-flex align-items-center">
                                            <img src="{{ product.image_url }}" alt="{{ product.name }}" 
                                                 class="rounded me-2" style="width: 35px; height: 35px; object-fit: cover;">
                                            <div style="flex: 1;">
                                                <div style="font-size: 11px; font-weight: 600; color: #333; margin-bottom: 2px;">
                                                    {{ product.name }}
                                                </div>
                                                <div style="font-size: 9px; color: #666;">
                                                    Quantidade: {{ quantity }} √ó R$ {{ "%.2f"|format(product.price) }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal:</span>
                                <span id="summary-subtotal">R$ {{ "%.2f"|format(total_value) }}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Frete:</span>
                                <span id="summary-shipping">Gr√°tis</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-3">
                                <strong>Total:</strong>
                                <strong id="summary-total">R${{ "%.2f"|format(total_value) }}</strong>
                            </div>

                            <!-- PIX Payment Option -->
                            <div class="payment-method mb-4">
                                <div class="alert alert-success">
                                    <h6>üí∏ Pagamento via PIX</h6>
                                    <div class="pix-calculation">
                                        <div class="d-flex justify-content-between">
                                            <span>Total via PIX:</span>
                                            <strong class="text-success" id="pix-total">R${{ "%.2f"|format(total_value) }}</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Finalize Button -->
                            <button type="button" id="finalize-pix-payment" class="btn-pix-finalizar mb-3">
                                üîí Finalizar Compra via PIX
                            </button>
                            
                            <!-- Loading state -->
                            <div id="payment-loading" class="text-center" style="display: none;">
                                <div class="spinner-border text-warning" role="status">
                                    <span class="visually-hidden">Processando...</span>
                                </div>
                                <p class="mt-2">Processando seu pagamento...</p>
                            </div>
                            
                            <!-- PIX Payment Section -->
                            <div id="pix-payment-section" style="display: none;">
                                <div class="alert alert-info">
                                    <h5 class="alert-heading">üì± Pagamento PIX Gerado!</h5>
                                    <hr>
                                    
                                    <!-- QR Code -->
                                    <div class="text-center mb-3">
                                        <div id="qr-code-container" class="mb-3">
                                            <div class="bg-white p-3 rounded d-inline-block">
                                                <canvas id="qr-code"></canvas>
                                            </div>
                                        </div>
                                        <p><strong>Escaneie o QR Code com seu banco</strong></p>
                                    </div>
                                    
                                    <!-- PIX Copy and Paste -->
                                    <div class="mb-3">
                                        <label class="form-label"><strong>Ou copie e cole o c√≥digo PIX:</strong></label>
                                        <div class="input-group">
                                            <input type="text" id="pix-code" class="form-control" readonly>
                                            <button class="btn-copiar-pix" type="button" id="copy-pix-code">
                                                üìã Copiar
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Payment Status -->
                                    <div id="payment-status" class="text-center">
                                        <p class="mb-2">‚è≥ Aguardando pagamento...</p>
                                        <small class="text-muted">O pagamento ser√° confirmado automaticamente</small>
                                    </div>
                                    
                                    <!-- Success message -->
                                    <div id="payment-success" class="text-center" style="display: none;">
                                        <div class="alert alert-success">
                                            <h5>Pagamento Confirmado</h5>
                                            <p>Obrigado pela compra!</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Security Icons -->
                            <div class="security-section">
                                <h6 class="mb-3">üîí Compra 100% Segura</h6>
                                <div class="row text-center mb-3">
                                    <div class="col-4">
                                        <div class="security-badge p-2 border rounded">
                                            <i class="fas fa-shield-alt fa-2x text-success mb-1"></i>
                                            <div class="small">Site Seguro</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="security-badge p-2 border rounded">
                                            <i class="fab fa-pix fa-2x text-primary mb-1"></i>
                                            <div class="small">PIX Seguro</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="security-badge p-2 border rounded">
                                            <i class="fas fa-truck fa-2x text-warning mb-1"></i>
                                            <div class="small">Entrega Garantida</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Customer Reviews -->
                                <div class="customer-reviews">
                                    <h6 class="mb-3">üí¨ O que dizem sobre n√≥s</h6>
                                    
                                    <div class="review-card mb-3 p-3 bg-light rounded border">
                                        <div class="d-flex align-items-start mb-2">
                                            <img src="https://raw.githubusercontent.com/gerencial03/imagens/refs/heads/main/download%20(3).png" alt="Reclame Aqui" class="me-3" style="width: 60px; height: 60px; object-fit: cover; border-radius: 12px; flex-shrink: 0;">
                                            <div class="flex-grow-1">
                                                <div class="d-flex align-items-center mb-2">
                                                    <span class="fw-bold me-2" style="font-size: 16px;">Reclame Aqui</span>
                                                    <div class="stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                                                </div>
                                                <p class="mb-0 text-dark" style="font-size: 15px; line-height: 1.4;">"Produto chegou rapidinho e muito bem embalado! Qualidade excepcional, j√° √© minha segunda compra."</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="review-card mb-3 p-3 bg-light rounded border">
                                        <div class="d-flex align-items-start mb-2">
                                            <img src="https://raw.githubusercontent.com/gerencial03/imagens/refs/heads/main/download%20(4).jpeg" alt="Correio" class="me-3" style="width: 60px; height: 60px; object-fit: cover; border-radius: 12px; flex-shrink: 0;">
                                            <div class="flex-grow-1">
                                                <div class="d-flex align-items-center mb-2">
                                                    <span class="fw-bold me-2" style="font-size: 16px;">Correio</span>
                                                    <div class="stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                                                </div>
                                                <p class="mb-0 text-dark" style="font-size: 15px; line-height: 1.4;">"Atendimento excelente, recomendo! Entrega super r√°pida e produto exatamente como esperado."</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="review-card mb-3 p-3 bg-light rounded border">
                                        <div class="d-flex align-items-start mb-2">
                                            <img src="https://raw.githubusercontent.com/gerencial03/imagens/refs/heads/main/download%20(4).png?v=1753355202" alt="Mercado Livre" class="me-3" style="width: 60px; height: 60px; object-fit: cover; border-radius: 12px; flex-shrink: 0;">
                                            <div class="flex-grow-1">
                                                <div class="d-flex align-items-center mb-2">
                                                    <span class="fw-bold me-2" style="font-size: 16px;">Mercado Livre</span>
                                                    <div class="stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                                                </div>
                                                <p class="mb-0 text-dark" style="font-size: 15px; line-height: 1.4;">"Melhor site de cosm√©ticos que j√° comprei! Produtos originais e pre√ßos justos."</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Selected Products Section -->
        <div class="container mt-5 mb-5">
            <div class="card">
                <div class="card-header bg-warning text-white" style="background-color: #e67e22 !important;">
                    <h5 class="mb-0">üõí Produtos Selecionados</h5>
                </div>
                <div class="card-body">
                    <div id="selected-products">
                        {% for item in checkout_items %}
                        <div class="row align-items-center mb-3 pb-3 {% if not loop.last %}border-bottom{% endif %}" data-product-id="{{ item.product.id }}">
                            <div class="col-md-3">
                                <img src="{{ item.product.image_url }}" alt="{{ item.product.name }}" class="img-fluid rounded">
                            </div>
                            <div class="col-md-9">
                                <h6>{{ item.product.name }}</h6>
                                <div class="d-flex align-items-center">
                                    <span class="text-muted me-2">Quantidade:</span>
                                    <span class="badge bg-primary fs-6">{{ item.quantity }}x</span>
                                </div>
                                <small class="text-muted">{{ item.product.description }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Add more products section -->
                    <div class="mt-4">
                        <h6 class="mb-3">‚ûï Adicionar mais produtos</h6>
                        <div class="row">
                            {% for similar_product in similar_products %}
                            <div class="col-md-4 mb-3">
                                <div class="card h-100">
                                    <img src="{{ similar_product.image_url }}" class="card-img-top" alt="{{ similar_product.name }}" style="height: 120px; object-fit: cover;">
                                    <div class="card-body p-2">
                                        <h6 class="card-title small">{{ similar_product.name }}</h6>
                                        <div class="price mb-2">
                                            <span class="fw-bold text-success">R${{ "%.2f"|format(similar_product.price) }}</span>
                                            {% if similar_product.original_price %}
                                            <small class="text-muted text-decoration-line-through ms-1">R${{ "%.2f"|format(similar_product.original_price) }}</small>
                                            {% endif %}
                                        </div>
                                        <button class="btn btn-sm btn-warning w-100" onclick="addProductToCheckout('{{ similar_product.id }}')" style="background-color: #e67e22; border-color: #e67e22;">
                                            + Adicionar
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.checkout-header {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.security-badge {
    transition: transform 0.2s;
}

.security-badge:hover {
    transform: translateY(-2px);
}

.trust-item img {
    width: 32px;
    height: 32px;
    object-fit: contain;
}

.stars {
    color: #ffc107;
}

.form-check:hover {
    background-color: #f8f9fa;
}

.form-check-input:checked ~ .form-check-label {
    background-color: rgba(230, 126, 34, 0.1);
}

.pix-discount {
    color: #28a745;
    font-weight: bold;
}

.review-card {
    border-left: 3px solid #e67e22;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let totalValue = {{ total_value }};
    let subtotal = totalValue;
    const shippingOptions = document.querySelectorAll('input[name="shipping"]');
    const summaryShipping = document.getElementById('summary-shipping');
    const summaryTotal = document.getElementById('summary-total');
    const pixTotalMainElement = document.getElementById('pix-total');
    
    console.log('Subtotal calculado:', subtotal);
    
    // Function to add product to checkout
    window.addProductToCheckout = function(productId) {
        console.log('Adicionando produto:', productId);
        
        // Send AJAX request to add product and update page dynamically
        fetch(`/add_to_checkout_ajax/${productId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            console.log('Resposta recebida:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Dados recebidos do servidor:', data);
            if (data.success) {
                console.log('RESPOSTA SUCESSO - Iniciando atualiza√ß√µes...');
                
                // 1. Atualizar se√ß√£o "Produtos Selecionados"
                console.log('1. Atualizando produtos selecionados...');
                updateSelectedProducts(data.checkout_items);
                
                // 2. Atualizar se√ß√£o "üí≥ Resumo do Pagamento" 
                console.log('2. Atualizando resumo do pagamento...');
                updatePaymentSummary(data.total_value, data.checkout_items);
                
                // 3. Feedback visual
                showSuccessMessage('Produto adicionado com sucesso!');
                scrollToPaymentSummary();
                
                console.log('TODAS AS ATUALIZA√á√ïES CONCLU√çDAS!');
            } else {
                console.error('Erro na resposta do servidor:', data);
            }
        })
        .catch(error => {
            console.error('Erro ao adicionar produto:', error);
            // Fallback: redirect to old method
            window.location.href = `/add_to_checkout/${productId}`;
        });
    };
    
    function updateSelectedProducts(checkoutItems) {
        console.log('=== ATUALIZANDO PRODUTOS SELECIONADOS ===');
        console.log('Produtos para mostrar:', checkoutItems.length);
        
        const selectedProductsDiv = document.getElementById('selected-products');
        if (!selectedProductsDiv) {
            console.error('ERRO: Elemento selected-products n√£o encontrado!');
            return;
        }
        
        selectedProductsDiv.innerHTML = '';
        
        if (checkoutItems.length === 0) {
            selectedProductsDiv.innerHTML = `
                <div class="text-center p-4" style="color: #666;">
                    <p>Nenhum produto selecionado</p>
                </div>
            `;
        } else {
            checkoutItems.forEach((item, index) => {
                console.log(`Adicionando √† lista de produtos: ${item.product.name}`);
                const productHtml = `
                    <div class="row align-items-center mb-3 pb-3 ${index < checkoutItems.length - 1 ? 'border-bottom' : ''}" data-product-id="${item.product.id}">
                        <div class="col-md-3">
                            <img src="${item.product.image_url}" alt="${item.product.name}" class="img-fluid rounded">
                        </div>
                        <div class="col-md-9">
                            <h6>${item.product.name}</h6>
                            <div class="d-flex align-items-center">
                                <span class="text-muted me-2">Quantidade:</span>
                                <span class="badge bg-primary fs-6">${item.quantity}x</span>
                            </div>
                            <small class="text-muted">${item.product.description}</small>
                        </div>
                    </div>
                `;
                selectedProductsDiv.innerHTML += productHtml;
            });
        }
        console.log('=== PRODUTOS SELECIONADOS ATUALIZADOS ===');
    }
    
    function updatePaymentSummary(newTotalValue, checkoutItems) {
        console.log('=== INICIANDO updatePaymentSummary ===');
        console.log('Total Value recebido:', newTotalValue);
        console.log('Checkout Items recebidos:', checkoutItems.length, 'produtos');
        
        // Update global variables
        totalValue = newTotalValue;
        subtotal = newTotalValue;
        
        // PRIORITY 1: Update subtotal immediately
        const subtotalElement = document.getElementById('summary-subtotal');
        if (subtotalElement) {
            const formattedTotal = `R$ ${totalValue.toFixed(2).replace('.', ',')}`;
            subtotalElement.textContent = formattedTotal;
            console.log('‚úÖ SUBTOTAL ATUALIZADO INSTANTANEAMENTE:', formattedTotal);
        } else {
            console.error('‚ùå ERRO CR√çTICO: Elemento summary-subtotal n√£o encontrado!');
        }
        
        // Calculate and update shipping and totals immediately
        const shippingCost = 0; // Always free shipping
        const finalTotal = totalValue + shippingCost;
        const pixTotal = finalTotal;
        
        // Update shipping immediately
        const shippingElement = document.getElementById('summary-shipping');
        if (shippingElement) {
            shippingElement.textContent = shippingCost === 0 ? 'Gr√°tis' : `R$ ${shippingCost.toFixed(2).replace('.', ',')}`;
            console.log('‚úÖ FRETE ATUALIZADO INSTANTANEAMENTE:', shippingElement.textContent);
        }
        
        // Update total immediately
        const totalElement = document.getElementById('summary-total');
        if (totalElement) {
            totalElement.textContent = `R$ ${finalTotal.toFixed(2).replace('.', ',')}`;
            console.log('‚úÖ TOTAL ATUALIZADO INSTANTANEAMENTE:', totalElement.textContent);
        }
        
        // Update PIX total immediately
        const pixTotalElement = document.getElementById('pix-total');
        if (pixTotalElement) {
            pixTotalElement.textContent = `R$ ${pixTotal.toFixed(2).replace('.', ',')}`;
            console.log('‚úÖ PIX TOTAL ATUALIZADO INSTANTANEAMENTE:', pixTotalElement.textContent);
        }
        
        // Update products info in payment summary
        const productsSummaryDiv = document.getElementById('payment-products-summary');
        console.log('Elemento payment-products-summary encontrado:', !!productsSummaryDiv);
        
        if (productsSummaryDiv) {
            console.log('Reconstruindo resumo do pagamento com', checkoutItems.length, 'produtos...');
            
            // Clear existing products and rebuild from backend data
            productsSummaryDiv.innerHTML = '';
            
            if (checkoutItems.length === 0) {
                // Show empty cart message
                productsSummaryDiv.innerHTML = `
                    <div class="text-center p-4" style="color: #666; font-style: italic;">
                        <i class="fas fa-shopping-cart" style="font-size: 24px; color: #ccc; margin-bottom: 10px;"></i>
                        <br>Carrinho vazio
                        <br><small>Adicione produtos para continuar</small>
                    </div>
                `;
            } else {
                checkoutItems.forEach((item, index) => {
                    console.log(`Adicionando produto ${index + 1}:`, item.product.name, `(${item.quantity}x)`);
                    
                    // Add product to summary
                    const productHtml = `
                        <div class="mb-2 p-2 product-summary-item" style="background-color: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6; position: relative;" data-product-id="${item.product.id}">
                            <button class="btn-remove-product" onclick="removeProductFromSummary('${item.product.id}')" style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center;" title="Remover este produto">√ó</button>
                            <div class="d-flex align-items-center">
                                <img src="${item.product.image_url}" alt="${item.product.name}" 
                                     class="rounded me-2" style="width: 35px; height: 35px; object-fit: cover;">
                                <div style="flex: 1;">
                                    <div style="font-size: 11px; font-weight: 600; color: #333; margin-bottom: 2px;">
                                        ${item.product.name}
                                    </div>
                                    <div class="product-quantity-info" style="font-size: 9px; color: #666;">
                                        Quantidade: ${item.quantity} √ó R$ ${item.product.price.toFixed(2).replace('.', ',')} = R$ ${item.subtotal.toFixed(2).replace('.', ',')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    productsSummaryDiv.innerHTML += productHtml;
                });
            }
            console.log('=== FIM: Resumo reconstru√≠do com', checkoutItems.length, 'produtos ===');
        } else {
            console.error('ERRO: Elemento payment-products-summary n√£o encontrado!');
        }
        
        // Note: Shipping, total and PIX total already updated above
        
        // Update finalize button
        const finalizeButton = document.querySelector('.btn-warning');
        if (finalizeButton) {
            finalizeButton.innerHTML = `üîí Finalizar Compra via PIX - R$ ${pixTotal.toFixed(2).replace('.', ',')}`;
            console.log('Bot√£o finalizar atualizado:', pixTotal.toFixed(2));
        }
        
        console.log('=== TODOS OS VALORES ATUALIZADOS ===');
    }
    
    function showSuccessMessage(message) {
        // Create and show a temporary success message
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 3000);
    }
    
    function scrollToPaymentSummary() {
        // Find the payment summary section using multiple strategies
        let paymentSummaryElement = null;
        
        // Strategy 1: Look for h5 elements containing the specific text
        const h5Elements = document.querySelectorAll('h5');
        for (let h5 of h5Elements) {
            if (h5.textContent && h5.textContent.includes('üí≥ Resumo do Pagamento')) {
                paymentSummaryElement = h5;
                break;
            }
        }
        
        // Strategy 2: Look for any element containing this text
        if (!paymentSummaryElement) {
            const allElements = document.querySelectorAll('*');
            for (let element of allElements) {
                if (element.textContent && element.textContent.trim() === 'üí≥ Resumo do Pagamento') {
                    paymentSummaryElement = element;
                    break;
                }
            }
        }
        
        // Strategy 3: Look for elements containing just "Resumo do Pagamento"
        if (!paymentSummaryElement) {
            const allElements = document.querySelectorAll('*');
            for (let element of allElements) {
                if (element.textContent && element.textContent.includes('Resumo do Pagamento')) {
                    paymentSummaryElement = element;
                    break;
                }
            }
        }
        
        if (paymentSummaryElement) {
            // Calculate position to center the element on screen
            const elementRect = paymentSummaryElement.getBoundingClientRect();
            const elementTop = elementRect.top + window.pageYOffset;
            const windowHeight = window.innerHeight;
            const scrollToPosition = elementTop - (windowHeight / 2) + (elementRect.height / 2);
            
            console.log('Scrolling to payment summary at position:', scrollToPosition);
            
            // Smooth scroll to the calculated position
            window.scrollTo({
                top: Math.max(0, scrollToPosition),
                behavior: 'smooth'
            });
        } else {
            console.log('Payment summary element not found, scrolling up');
            // Fallback: scroll up a bit
            window.scrollTo({
                top: Math.max(0, window.pageYOffset - 400),
                behavior: 'smooth'
            });
        }
    }
    
    // Function to remove product from summary
    window.removeProductFromSummary = function(productId) {
        // Get product name for better feedback
        const productElement = document.querySelector(`[data-product-id="${productId}"]`);
        const productName = productElement ? productElement.querySelector('.product-summary-item div div div').textContent : 'Produto';
        
        fetch(`/remove_from_checkout_ajax/${productId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Produto removido:', productId);
                console.log('Produtos restantes:', data.checkout_items.length);
                
                // Update the selected products section
                updateSelectedProducts(data.checkout_items);
                // Update payment summary
                updatePaymentSummary(data.total_value, data.checkout_items);
                
                // Show appropriate message
                if (data.checkout_items.length === 0) {
                    showSuccessMessage('Carrinho vazio! Adicione produtos para continuar.');
                    // Hide payment form when cart is empty
                    const paymentForm = document.querySelector('form[action="/process_pix_payment"]');
                    if (paymentForm) {
                        paymentForm.style.display = 'none';
                    }
                } else {
                    showSuccessMessage(`${productName.split(':')[0]} removido do carrinho!`);
                }
            }
        })
        .catch(error => {
            console.error('Erro ao remover produto:', error);
            showSuccessMessage('Erro ao remover produto. Tente novamente.');
        });
    };

    function updateTotals() {
        let selectedShipping = document.querySelector('input[name="shipping"]:checked');
        
        // Handle hidden input for free shipping
        if (!selectedShipping) {
            selectedShipping = document.querySelector('input[name="shipping"][type="hidden"]');
        }
        
        if (!selectedShipping) {
            console.log('Nenhuma op√ß√£o de frete selecionada');
            return;
        }
        
        const shippingCost = parseFloat(selectedShipping.value) || 0;
        const total = subtotal + shippingCost;

        // Update shipping display
        if (shippingCost === 0) {
            summaryShipping.textContent = 'Gr√°tis';
        } else {
            summaryShipping.textContent = `R$ ${shippingCost.toFixed(2).replace('.', ',')}`;
        }

        // Update total
        summaryTotal.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        
        // Update PIX total
        if (pixTotalMainElement) {
            pixTotalMainElement.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        }
        
        // Update finalize button
        const finalizeButton = document.querySelector('.btn-warning');
        if (finalizeButton) {
            finalizeButton.innerHTML = `üîí Finalizar Compra via PIX - R$ ${total.toFixed(2).replace('.', ',')}`;
        }
    }

    // Add event listeners only to visible shipping options (not hidden)
    const visibleShippingOptions = document.querySelectorAll('input[name="shipping"]:not([type="hidden"])');
    
    visibleShippingOptions.forEach((option, index) => {
        option.addEventListener('change', function() {
            updateTotals();
        });
    });

    // Initial update
    updateTotals();

    // CEP Integration
    const cepInput = document.getElementById('customer_cep');
    const cepLoading = document.getElementById('cep-loading');
    const cepError = document.getElementById('cep-error');
    const enderecoInput = document.getElementById('customer_endereco');
    const bairroInput = document.getElementById('customer_bairro');
    const cidadeInput = document.getElementById('customer_cidade');
    const ufSelect = document.getElementById('customer_uf');

    // Format CEP input
    cepInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 5) {
            value = value.substring(0, 5) + '-' + value.substring(5, 8);
        }
        e.target.value = value;
        
        // Auto-fill when CEP is complete
        if (value.length === 9) {
            fillAddressFromCEP(value.replace('-', ''));
        }
    });

    // CEP API Integration
    async function fillAddressFromCEP(cep) {
        if (cep.length !== 8) return;

        // Show loading
        if (cepLoading) cepLoading.style.display = 'block';
        if (cepError) cepError.style.display = 'none';
        
        // Clear previous data
        if (enderecoInput) enderecoInput.value = '';
        if (bairroInput) bairroInput.value = '';
        if (cidadeInput) cidadeInput.value = '';
        if (ufSelect) ufSelect.value = '';

        try {
            const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            
            if (!response.ok) {
                throw new Error('Erro ao consultar CEP');
            }
            
            const data = await response.json();

            if (data.erro) {
                throw new Error('CEP n√£o encontrado');
            }

            // Fill form fields
            if (enderecoInput) enderecoInput.value = data.logradouro || '';
            if (bairroInput) bairroInput.value = data.bairro || '';
            if (cidadeInput) cidadeInput.value = data.localidade || '';
            if (ufSelect) ufSelect.value = data.uf || '';

            // Hide loading
            if (cepLoading) cepLoading.style.display = 'none';
            
            // Focus on number field (next input after CEP)
            const numberField = document.getElementById('customer_numero');
            if (numberField) numberField.focus();

        } catch (error) {
            console.warn('Erro ao buscar CEP:', error.message);
            if (cepLoading) cepLoading.style.display = 'none';
            if (cepError) cepError.style.display = 'block';
            
            // Hide error after 3 seconds
            setTimeout(() => {
                if (cepError) cepError.style.display = 'none';
            }, 3000);
        }
    }

    // Manual CEP lookup on blur
    cepInput.addEventListener('blur', function() {
        const cep = this.value.replace(/\D/g, '');
        if (cep.length === 8) {
            fillAddressFromCEP(cep);
        }
    });

    // PIX Payment Processing
    const finalizeButton = document.getElementById('finalize-pix-payment');
    const paymentLoading = document.getElementById('payment-loading');
    const pixPaymentSection = document.getElementById('pix-payment-section');
    
    finalizeButton.addEventListener('click', function() {
        processPixPayment();
    });

    // Format CPF input
    const cpfInput = document.getElementById('customer_cpf');
    cpfInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length <= 11) {
            value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }
        e.target.value = value;
    });

    // Format phone input
    const phoneInput = document.getElementById('customer_phone');
    phoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length <= 11) {
            value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        }
        e.target.value = value;
    });

    async function processPixPayment() {
        // Validate required fields manually
        const requiredInputs = [
            { id: 'customer_name', label: 'Nome Completo' },
            { id: 'customer_email', label: 'E-mail' },
            { id: 'customer_phone', label: 'Telefone' },
            { id: 'customer_cpf', label: 'CPF' }
        ];

        for (const input of requiredInputs) {
            const element = document.getElementById(input.id);
            if (!element || !element.value.trim()) {
                alert(`Por favor, preencha o campo: ${input.label}`);
                if (element) element.focus();
                return;
            }
        }

        // Get total amount with PIX discount
        let selectedShipping = document.querySelector('input[name="shipping"]:checked');
        if (!selectedShipping) {
            selectedShipping = document.querySelector('input[name="shipping"][type="hidden"]');
        }
        
        const shippingCost = selectedShipping ? parseFloat(selectedShipping.value) || 0 : 0;
        const total = subtotal + shippingCost;

        // Show loading
        if (finalizeButton) finalizeButton.style.display = 'none';
        if (paymentLoading) paymentLoading.style.display = 'block';

        try {
            // Prepare form data
            const formData = new FormData();
            formData.append('customer_name', document.getElementById('customer_name').value.trim());
            formData.append('customer_email', document.getElementById('customer_email').value.trim());
            formData.append('customer_phone', document.getElementById('customer_phone').value.replace(/\D/g, ''));
            formData.append('customer_cpf', document.getElementById('customer_cpf').value.replace(/\D/g, ''));
            formData.append('customer_cep', (document.getElementById('customer_cep').value || '').replace(/\D/g, ''));
            formData.append('customer_endereco', (document.getElementById('customer_endereco').value || '').trim());
            formData.append('customer_numero', (document.getElementById('customer_numero').value || '').trim());
            formData.append('customer_bairro', (document.getElementById('customer_bairro').value || '').trim());
            formData.append('customer_cidade', (document.getElementById('customer_cidade').value || '').trim());
            formData.append('customer_uf', (document.getElementById('customer_uf').value || ''));
            formData.append('total_amount', total.toFixed(2));

            // Make API request
            const response = await fetch('/process_pix_payment', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
                // Hide loading and show PIX payment section
                if (paymentLoading) paymentLoading.style.display = 'none';
                if (pixPaymentSection) pixPaymentSection.style.display = 'block';

                // Generate QR Code
                if (result.transaction && result.transaction.pix_qr_code) {
                    generateQRCode(result.transaction.pix_qr_code);
                }

                // Set PIX copy and paste code
                if (result.transaction && result.transaction.pix_copy_paste) {
                    const pixCodeInput = document.getElementById('pix-code');
                    if (pixCodeInput) {
                        pixCodeInput.value = result.transaction.pix_copy_paste;
                    }
                }

                // Start payment status polling
                if (result.transaction && result.transaction.hash) {
                    startPaymentStatusPolling(result.transaction.hash);
                }
            } else {
                throw new Error(result.error || 'Erro ao processar pagamento');
            }

        } catch (error) {
            console.warn('Erro no pagamento PIX:', error);
            
            let errorMessage = 'Erro ao processar pagamento. Tente novamente.';
            if (error.message && (error.message.includes('network') || error.message.includes('fetch'))) {
                errorMessage = 'Erro de conex√£o. Verifique sua internet e tente novamente.';
            } else if (error.message) {
                errorMessage = error.message;
            }
            
            alert(errorMessage);
            
            // Show button again
            if (paymentLoading) paymentLoading.style.display = 'none';
            if (finalizeButton) finalizeButton.style.display = 'block';
        }
    }

    function generateQRCode(qrCodeData) {
        const canvas = document.getElementById('qr-code');
        if (!canvas) {
            console.warn('Canvas QR Code n√£o encontrado');
            return;
        }
        
        // Try multiple QR code libraries
        if (typeof QRCode !== 'undefined' && QRCode.toCanvas) {
            // Using qrcode.js library
            try {
                QRCode.toCanvas(canvas, qrCodeData, {
                    width: 200,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                }, function (error) {
                    if (error) {
                        console.warn('Erro ao gerar QR Code com qrcode.js:', error);
                        generateQRCodeFallback(qrCodeData, canvas);
                    } else {
                        console.log('QR Code gerado com sucesso usando qrcode.js');
                    }
                });
                return;
            } catch (e) {
                console.warn('Erro na biblioteca qrcode.js:', e);
            }
        }
        
        // Fallback to qrcode-generator library
        if (typeof qrcode !== 'undefined') {
            try {
                const qr = qrcode(0, 'M');
                qr.addData(qrCodeData);
                qr.make();
                
                const size = 200;
                const moduleSize = Math.floor(size / qr.getModuleCount());
                canvas.width = canvas.height = qr.getModuleCount() * moduleSize;
                
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#000000';
                
                for (let row = 0; row < qr.getModuleCount(); row++) {
                    for (let col = 0; col < qr.getModuleCount(); col++) {
                        if (qr.isDark(row, col)) {
                            ctx.fillRect(col * moduleSize, row * moduleSize, moduleSize, moduleSize);
                        }
                    }
                }
                
                console.log('QR Code gerado com sucesso usando qrcode-generator');
                return;
            } catch (e) {
                console.warn('Erro na biblioteca qrcode-generator:', e);
            }
        }
        
        // Final fallback - manual QR code generation
        generateQRCodeFallback(qrCodeData, canvas);
    }
    
    function generateQRCodeFallback(qrCodeData, canvas) {
        // Create a simple pattern as fallback
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.height = 200;
        
        // White background
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, 200, 200);
        
        // Black border
        ctx.fillStyle = '#000000';
        ctx.fillRect(0, 0, 200, 10);
        ctx.fillRect(0, 190, 200, 10);
        ctx.fillRect(0, 0, 10, 200);
        ctx.fillRect(190, 0, 10, 200);
        
        // Create a simple pattern to indicate it's a QR code
        ctx.fillStyle = '#000000';
        for (let i = 20; i < 180; i += 20) {
            for (let j = 20; j < 180; j += 20) {
                if ((i + j) % 40 === 0) {
                    ctx.fillRect(i, j, 10, 10);
                }
            }
        }
        
        // Add text
        ctx.fillStyle = '#000000';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('QR CODE PIX', 100, 100);
        
        console.log('QR Code fallback gerado');
    }

    // Copy PIX code to clipboard
    document.getElementById('copy-pix-code').addEventListener('click', function() {
        const pixCode = document.getElementById('pix-code');
        pixCode.select();
        document.execCommand('copy');
        
        // Visual feedback
        const button = this;
        const originalText = button.textContent;
        button.textContent = '‚úÖ Copiado!';
        button.classList.add('btn-success');
        button.classList.remove('btn-outline-secondary');
        
        setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 2000);
    });

    function startPaymentStatusPolling(transactionHash) {
        const statusInterval = setInterval(async () => {
            try {
                const response = await fetch(`/check_payment_status/${transactionHash}`);
                const result = await response.json();

                if (result.success) {
                    if (result.status === 'paid' || result.status === 'approved') {
                        // Payment successful
                        clearInterval(statusInterval);
                        document.getElementById('payment-status').style.display = 'none';
                        document.getElementById('payment-success').style.display = 'block';
                        
                        // Don't redirect automatically - let user stay on the page
                        console.log('PIX processado com sucesso');
                    } else if (result.status === 'cancelled' || result.status === 'expired') {
                        // Payment failed
                        clearInterval(statusInterval);
                        alert('Pagamento cancelado ou expirado. Tente novamente.');
                        location.reload();
                    }
                }
            } catch (error) {
                console.error('Erro ao verificar status:', error);
            }
        }, 5000); // Check every 5 seconds

        // Stop polling after 15 minutes
        setTimeout(() => {
            clearInterval(statusInterval);
        }, 15 * 60 * 1000);
    }
});
</script>
{% endblock %}