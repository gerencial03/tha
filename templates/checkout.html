{% extends "base.html" %}

{% block title %}Finalizar Compra - Tha Beauty{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="checkout-header bg-white border-bottom">
        <div class="container">
            <div class="row align-items-center py-3">
                <div class="col-md-6">
                    <img src="{{ url_for('static', filename='fbda12e0-49d4-4f89-81fb-uuuuuu_1753317109337.png') }}" alt="Tha Beauty" height="40">
                </div>
                <div class="col-md-6 text-end">
                    <span class="fw-bold">üöö Frete gr√°tis a partir de R$ 100</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <div class="row">
            <!-- Product Summary -->
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">üõí Resumo do Pedido</h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <img src="{{ product.image_url }}" alt="{{ product.name }}" class="img-fluid rounded">
                            </div>
                            <div class="col-md-5">
                                <h6>{{ product.name }}</h6>
                                <div class="d-flex align-items-center">
                                    <span class="text-muted me-2">Quantidade:</span>
                                    <span class="badge bg-primary fs-6">{{ quantity }}x</span>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-center">
                                    <div class="fw-bold">R${{ "%.2f"|format(product.price) }}</div>
                                    <small class="text-muted">por unidade</small>
                                    {% if product.original_price %}
                                    <div><small class="text-muted text-decoration-line-through">R${{ "%.2f"|format(product.original_price) }}</small></div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3 text-end">
                                <div class="text-center">
                                    <div class="fw-bold text-success h5 mb-0" id="subtotal">R${{ "%.2f"|format(product.price * quantity) }}</div>
                                    <small class="text-muted">total</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Shipping Options -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">üöö {% if product.price * quantity >= 100 %}Frete Gr√°tis{% else %}Op√ß√µes de Frete{% endif %}</h5>
                    </div>
                    <div class="card-body">
                        <div class="shipping-options">
                            {% set subtotal = product.price * quantity %}
                            {% if subtotal >= 100 %}
                            <!-- Free shipping only for orders above R$ 100 -->
                            <div class="alert alert-success text-center mb-0 p-4" style="border: 2px solid #28a745; background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);">
                                <div class="mb-3">
                                    <i class="fas fa-shipping-fast fa-3x text-success"></i>
                                </div>
                                <h4 class="mb-2 text-success fw-bold">üéâ Parab√©ns! Seu frete √© GR√ÅTIS!</h4>
                                <p class="mb-2 text-dark">Compras acima de R$ 100,00 t√™m frete gr√°tis para todo o Brasil</p>
                                <div class="badge bg-success fs-6 py-2 px-3">Entrega em 5 a 10 dias √∫teis</div>
                                <input type="hidden" name="shipping" value="0">
                            </div>
                            {% else %}
                            <!-- Shipping options for orders below R$ 100 -->
                            <div class="form-check p-3 border rounded mb-2">
                                <input class="form-check-input" type="radio" name="shipping" id="sedex" value="11.90" checked data-days="5-10">
                                <label class="form-check-label w-100" for="sedex">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <strong>üì¶ Sedex</strong>
                                            <div class="text-muted">5 a 10 dias √∫teis</div>
                                        </div>
                                        <div class="fw-bold">R$ 11,90</div>
                                    </div>
                                </label>
                            </div>
                            
                            <div class="form-check p-3 border rounded">
                                <input class="form-check-input" type="radio" name="shipping" id="express" value="19.90" data-days="1-3">
                                <label class="form-check-label w-100" for="express">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <strong>‚ö° Express</strong>
                                            <div class="text-muted">1 a 3 dias √∫teis</div>
                                        </div>
                                        <div class="fw-bold">R$ 19,90</div>
                                    </div>
                                </label>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Customer Info -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">üìã Dados para Entrega</h5>
                    </div>
                    <div class="card-body">
                        <form>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nome Completo *</label>
                                    <input type="text" class="form-control" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">CPF *</label>
                                    <input type="text" class="form-control" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">E-mail *</label>
                                    <input type="email" class="form-control" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Telefone *</label>
                                    <input type="tel" class="form-control" required>
                                </div>
                                <div class="col-md-8 mb-3">
                                    <label class="form-label">CEP *</label>
                                    <input type="text" id="cep" class="form-control" placeholder="00000-000" maxlength="9" required>
                                    <div class="loading-cep" id="cep-loading" style="display: none;">
                                        <small class="text-primary">üîç Buscando CEP...</small>
                                    </div>
                                    <div class="invalid-cep" id="cep-error" style="display: none;">
                                        <small class="text-danger">‚ùå CEP n√£o encontrado</small>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">N√∫mero *</label>
                                    <input type="text" id="numero" class="form-control" required>
                                </div>
                                <div class="col-12 mb-3">
                                    <label class="form-label">Endere√ßo *</label>
                                    <input type="text" id="endereco" class="form-control" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Bairro *</label>
                                    <input type="text" id="bairro" class="form-control" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Cidade *</label>
                                    <input type="text" id="cidade" class="form-control" required>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">UF *</label>
                                    <select id="uf" class="form-control">
                                        <option value="">Selecione</option>
                                        <option value="AC">AC</option>
                                        <option value="AL">AL</option>
                                        <option value="AP">AP</option>
                                        <option value="AM">AM</option>
                                        <option value="BA">BA</option>
                                        <option value="CE">CE</option>
                                        <option value="DF">DF</option>
                                        <option value="ES">ES</option>
                                        <option value="GO">GO</option>
                                        <option value="MA">MA</option>
                                        <option value="MT">MT</option>
                                        <option value="MS">MS</option>
                                        <option value="MG">MG</option>
                                        <option value="PA">PA</option>
                                        <option value="PB">PB</option>
                                        <option value="PR">PR</option>
                                        <option value="PE">PE</option>
                                        <option value="PI">PI</option>
                                        <option value="RJ">RJ</option>
                                        <option value="RN">RN</option>
                                        <option value="RS">RS</option>
                                        <option value="RO">RO</option>
                                        <option value="RR">RR</option>
                                        <option value="SC">SC</option>
                                        <option value="SP">SP</option>
                                        <option value="SE">SE</option>
                                        <option value="TO">TO</option>
                                    </select>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Payment Summary -->
            <div class="col-lg-4">
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header bg-warning text-white" style="background-color: #e67e22 !important;">
                        <h5 class="mb-0">üí≥ Resumo do Pagamento</h5>
                    </div>
                    <div class="card-body">
                        <div class="payment-summary">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal:</span>
                                <span id="summary-subtotal">R${{ "%.2f"|format(product.price * quantity) }}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Frete:</span>
                                <span id="summary-shipping">{% if product.price * quantity >= 100 %}Gr√°tis{% else %}R$ 11,90{% endif %}</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-3">
                                <strong>Total:</strong>
                                <strong id="summary-total">R${{ "%.2f"|format(product.price * quantity + (0 if product.price * quantity >= 100 else 11.90)) }}</strong>
                            </div>

                            <!-- PIX Payment Option -->
                            <div class="payment-method mb-4">
                                <div class="alert alert-success">
                                    <h6>üí∏ Pagamento via PIX</h6>
                                    <div class="pix-discount mb-2">
                                        <strong>10% de desconto no PIX!</strong>
                                    </div>
                                    <div class="pix-calculation">
                                        <div class="d-flex justify-content-between">
                                            <span>Total com desconto PIX:</span>
                                            <strong class="text-success" id="pix-total">R${{ "%.2f"|format((product.price * quantity + (0 if product.price * quantity >= 100 else 11.90)) * 0.9) }}</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Finalize Button -->
                            <button class="btn btn-warning w-100 btn-lg mb-3" style="background-color: #e67e22; border-color: #e67e22;">
                                üîí Finalizar Compra via PIX
                            </button>

                            <!-- Security Icons -->
                            <div class="security-section">
                                <h6 class="mb-3">üîí Compra 100% Segura</h6>
                                <div class="row text-center mb-3">
                                    <div class="col-4">
                                        <div class="security-badge p-2 border rounded">
                                            <i class="fas fa-shield-alt fa-2x text-success mb-1"></i>
                                            <div class="small">Site Seguro</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="security-badge p-2 border rounded">
                                            <i class="fab fa-pix fa-2x text-primary mb-1"></i>
                                            <div class="small">PIX Seguro</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="security-badge p-2 border rounded">
                                            <i class="fas fa-truck fa-2x text-warning mb-1"></i>
                                            <div class="small">Entrega Garantida</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Company Reviews -->
                                <div class="company-reviews">
                                    <h6 class="mb-3">üí¨ O que dizem sobre n√≥s</h6>
                                    
                                    <!-- Reclame Aqui Review -->
                                    <div class="review-comment mb-3 p-3 border-start border-primary border-3" style="background: #f8f9fa;">
                                        <div class="d-flex align-items-start">
                                            <div class="company-avatar me-3" style="background: white; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 1px solid #ddd;">
                                                <img src="https://logodownload.org/wp-content/uploads/2019/10/reclame-aqui-logo-1.png" alt="Reclame Aqui" style="width: 32px; height: 32px; object-fit: contain;">
                                            </div>
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                    <strong style="color: #0066cc; font-size: 14px;">Reclame Aqui</strong>
                                                    <div class="rating">
                                                        <span style="color: #ffc107;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                                                        <small class="text-muted ms-1">5.0</small>
                                                    </div>
                                                </div>
                                                <p class="mb-1 small text-dark">"Empresa com excelente reputa√ß√£o no atendimento ao consumidor. Produtos de qualidade e entrega r√°pida. Totalmente confi√°vel!"</p>
                                                <small class="text-muted">Verificado hoje</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Correios Review -->
                                    <div class="review-comment mb-3 p-3 border-start border-warning border-3" style="background: #f8f9fa;">
                                        <div class="d-flex align-items-start">
                                            <div class="company-avatar me-3" style="background: white; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 1px solid #ddd;">
                                                <img src="https://logodownload.org/wp-content/uploads/2019/01/correios-logo-2.png" alt="Correios" style="width: 32px; height: 32px; object-fit: contain;">
                                            </div>
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                    <strong style="color: #003366; font-size: 14px;">Correios</strong>
                                                    <div class="rating">
                                                        <span style="color: #ffc107;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                                                        <small class="text-muted ms-1">4.8</small>
                                                    </div>
                                                </div>
                                                <p class="mb-1 small text-dark">"Parceiro log√≠stico de confian√ßa. Entregas pontuais e embalagem adequada para produtos de beleza. Rastreamento sempre atualizado."</p>
                                                <small class="text-muted">Parceiro verificado</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Mercado Pago Review -->
                                    <div class="review-comment mb-3 p-3 border-start border-info border-3" style="background: #f8f9fa;">
                                        <div class="d-flex align-items-start">
                                            <div class="company-avatar me-3" style="background: white; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 1px solid #ddd;">
                                                <img src="https://logodownload.org/wp-content/uploads/2019/02/mercado-pago-logo-2.png" alt="Mercado Pago" style="width: 32px; height: 32px; object-fit: contain;">
                                            </div>
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                    <strong style="color: #00b5d8; font-size: 14px;">Mercado Pago</strong>
                                                    <div class="rating">
                                                        <span style="color: #ffc107;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                                                        <small class="text-muted ms-1">4.9</small>
                                                    </div>
                                                </div>
                                                <p class="mb-1 small text-dark">"Transa√ß√µes 100% seguras. Sistema antifraude robusto e processamento instant√¢neo. Loja verificada e aprovada para vendas."</p>
                                                <small class="text-muted">Certificado de seguran√ßa</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Customer Reviews -->
                                <div class="customer-reviews">
                                    <h6>üí¨ O que nossos clientes dizem:</h6>
                                    <div class="review-card mb-2 p-2 bg-light rounded">
                                        <div class="stars mb-1">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                                        <div class="small">"Produto chegou rapidinho e muito bem embalado!"</div>
                                        <div class="reviewer text-muted small">- Ana Silva</div>
                                    </div>
                                    <div class="review-card mb-2 p-2 bg-light rounded">
                                        <div class="stars mb-1">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                                        <div class="small">"Atendimento excelente, recomendo!"</div>
                                        <div class="reviewer text-muted small">- Mariana Costa</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.checkout-header {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.security-badge {
    transition: transform 0.2s;
}

.security-badge:hover {
    transform: translateY(-2px);
}

.trust-item img {
    width: 32px;
    height: 32px;
    object-fit: contain;
}

.stars {
    color: #ffc107;
}

.form-check:hover {
    background-color: #f8f9fa;
}

.form-check-input:checked ~ .form-check-label {
    background-color: rgba(230, 126, 34, 0.1);
}

.pix-discount {
    color: #28a745;
    font-weight: bold;
}

.review-card {
    border-left: 3px solid #e67e22;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const basePrice = {{ product.price }};
    const quantity = {{ quantity }};
    const subtotal = basePrice * quantity;
    const shippingOptions = document.querySelectorAll('input[name="shipping"]');
    const summaryShipping = document.getElementById('summary-shipping');
    const summaryTotal = document.getElementById('summary-total');
    const pixTotal = document.getElementById('pix-total');
    
    console.log('Pre√ßo unit√°rio:', basePrice);
    console.log('Quantidade:', quantity);
    console.log('Subtotal calculado:', subtotal);

    function updateTotals() {
        let selectedShipping = document.querySelector('input[name="shipping"]:checked');
        
        // Handle hidden input for free shipping
        if (!selectedShipping) {
            selectedShipping = document.querySelector('input[name="shipping"][type="hidden"]');
        }
        
        if (!selectedShipping) {
            console.log('Nenhuma op√ß√£o de frete selecionada');
            return;
        }
        
        const shippingCost = parseFloat(selectedShipping.value) || 0;
        const total = subtotal + shippingCost;
        const pixDiscountTotal = total * 0.9;

        // Update shipping display
        if (shippingCost === 0) {
            summaryShipping.textContent = 'Gr√°tis';
        } else {
            summaryShipping.textContent = `R$ ${shippingCost.toFixed(2).replace('.', ',')}`;
        }

        // Update total
        summaryTotal.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        
        // Update PIX total
        pixTotal.textContent = `R$ ${pixDiscountTotal.toFixed(2).replace('.', ',')}`;
        
        // Update finalize button
        const finalizeButton = document.querySelector('.btn-warning');
        if (finalizeButton) {
            finalizeButton.innerHTML = `üîí Finalizar Compra via PIX - R$ ${pixDiscountTotal.toFixed(2).replace('.', ',')}`;
        }
    }

    // Add event listeners only to visible shipping options (not hidden)
    const visibleShippingOptions = document.querySelectorAll('input[name="shipping"]:not([type="hidden"])');
    
    visibleShippingOptions.forEach((option, index) => {
        option.addEventListener('change', function() {
            updateTotals();
        });
    });

    // Initial update
    updateTotals();

    // CEP Integration
    const cepInput = document.getElementById('cep');
    const cepLoading = document.getElementById('cep-loading');
    const cepError = document.getElementById('cep-error');
    const enderecoInput = document.getElementById('endereco');
    const bairroInput = document.getElementById('bairro');
    const cidadeInput = document.getElementById('cidade');
    const ufSelect = document.getElementById('uf');

    // Format CEP input
    cepInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 5) {
            value = value.substring(0, 5) + '-' + value.substring(5, 8);
        }
        e.target.value = value;
        
        // Auto-fill when CEP is complete
        if (value.length === 9) {
            fillAddressFromCEP(value.replace('-', ''));
        }
    });

    // CEP API Integration
    async function fillAddressFromCEP(cep) {
        if (cep.length !== 8) return;

        // Show loading
        cepLoading.style.display = 'block';
        cepError.style.display = 'none';
        
        // Clear previous data
        enderecoInput.value = '';
        bairroInput.value = '';
        cidadeInput.value = '';
        ufSelect.value = '';

        try {
            const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            const data = await response.json();

            if (data.erro) {
                throw new Error('CEP n√£o encontrado');
            }

            // Fill form fields
            enderecoInput.value = data.logradouro || '';
            bairroInput.value = data.bairro || '';
            cidadeInput.value = data.localidade || '';
            ufSelect.value = data.uf || '';

            // Hide loading
            cepLoading.style.display = 'none';
            
            // Focus on number field (next input after CEP)
            const numberField = document.querySelector('input[placeholder]') || document.getElementById('numero');
            if (numberField) numberField.focus();

        } catch (error) {
            console.error('Erro ao buscar CEP:', error);
            cepLoading.style.display = 'none';
            cepError.style.display = 'block';
            
            // Hide error after 3 seconds
            setTimeout(() => {
                cepError.style.display = 'none';
            }, 3000);
        }
    }

    // Manual CEP lookup on blur
    cepInput.addEventListener('blur', function() {
        const cep = this.value.replace(/\D/g, '');
        if (cep.length === 8) {
            fillAddressFromCEP(cep);
        }
    });
});
</script>
{% endblock %}